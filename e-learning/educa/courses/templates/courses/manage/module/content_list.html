{% extends "base.html" %}
{% load course %}

{% block title %}
  Module {{ module.order|add:1 }}: {{ module.title }}
{% endblock %}

{% block content %}
{% with course=module.course %}
<div class="container mt-5">
  <h1 class="text-center">Course "{{ course.title }}"</h1>
  
  <!-- Modules List -->
  <div class="row mt-4">
    <div class="col-md-4">
      <h3>Modules</h3>
      <ul id="modules" class="list-group">
        {% for m in course.modules.all %}
          <li data-id="{{ m.id }}" class="list-group-item {% if m == module %}active{% endif %}">
            <a href="{% url 'module_content_list' m.id %}" class="text-decoration-none">
              <span>Module <span class="order">{{ m.order|add:1 }}</span></span><br>{{ m.title }}
            </a>
          </li>
        {% empty %}
          <li class="list-group-item">No modules yet.</li>
        {% endfor %}
      </ul>
      <a href="{% url 'course_module_update' course.id %}" class="btn btn-outline-secondary mt-3">Edit Modules</a>
    </div>

    <!-- Module Content -->
    <div class="col-md-8">
      <h2 class="mt-4">Module {{ module.order|add:1 }}: {{ module.title }}</h2>
      <h3>Module Contents</h3>
      <div id="module-contents" class="list-group">
        {% for content in module.contents.all %}
          <div data-id="{{ content.id }}" class="list-group-item d-flex justify-content-between align-items-center">
            {% with item=content.item %}
              <p class="mb-0">{{ item }} ({{ item|model_name }})</p>
              <div>
                <a href="{% url 'module_content_update' module.id item|model_name item.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                <form action="{% url 'module_content_delete' content.id %}" method="post" class="d-inline-block ms-2">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
                </form>
              </div>
            {% endwith %}
          </div>
        {% empty %}
          <p class="text-muted">This module has no contents yet.</p>
        {% endfor %}
      </div>

      <!-- Add New Content -->
      <h3 class="mt-4">Add New Content:</h3>
      <ul class="list-inline">
        <li class="list-inline-item"><a href="{% url 'module_content_create' module.id 'text' %}" class="btn btn-outline-secondary">Text</a></li>
        <li class="list-inline-item"><a href="{% url 'module_content_create' module.id 'image' %}" class="btn btn-outline-secondary">Image</a></li>
        <li class="list-inline-item"><a href="{% url 'module_content_create' module.id 'video' %}" class="btn btn-outline-secondary">Video</a></li>
        <li class="list-inline-item"><a href="{% url 'module_content_create' module.id 'file' %}" class="btn btn-outline-secondary">File</a></li>
      </ul>
    </div>
  </div>
</div>
{% endwith %}
{% endblock %}

{% block include_js %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5sortable/0.13.3/html5sortable.min.js"></script>
{% endblock %}

{% block domready %}
<script>
  var options = {
      method: 'POST',
      mode: 'same-origin'
  };

  const moduleOrderUrl = '{% url "module_order" %}';

  sortable('#modules', {
    forcePlaceholderSize: true,
    placeholderClass: 'placeholder'
  })[0].addEventListener('sortupdate', function(e) {
    let modulesOrder = {};
    document.querySelectorAll('#modules li').forEach((module, index) => {
      modulesOrder[module.dataset.id] = index;
      module.querySelector('.order').innerHTML = index + 1;
    });
    options.body = JSON.stringify(modulesOrder);
    fetch(moduleOrderUrl, options);
  });

  const contentOrderUrl = '{% url "content_order" %}';

  sortable('#module-contents', {
    forcePlaceholderSize: true,
    placeholderClass: 'placeholder'
  })[0].addEventListener('sortupdate', function(e) {
    let contentOrder = {};
    document.querySelectorAll('#module-contents div').forEach((content, index) => {
      contentOrder[content.dataset.id] = index;
    });
    options.body = JSON.stringify(contentOrder);
    fetch(contentOrderUrl, options);
  });
</script>
{% endblock %}
